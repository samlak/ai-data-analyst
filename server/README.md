# AI Procurement Data Analyst - Server Guide

This project provides a **server-side FastAPI application** that enables users to query a MongoDB dataset in natural language. It uses **Azure OpenAI** for Python code generation to perform data analysis and visualization. The server is part of a larger project, but this README focuses exclusively on the `server/` directory and its components.

---

## Directory Structure

```plaintext
server/
├── main.py                 # FastAPI server and API endpoints
├── upload-to-db.py         # Script to upload CSV data to MongoDB
├── static/                 # Directory for generated visualizations
└── .env                    # Environment variables for configuration
```

### File Descriptions

1. **`main.py`**  
   - FastAPI application that:
     - Exposes an API to query MongoDB using natural language.
     - Uses Azure OpenAI to generate Python code for analysis.
     - Executes the generated Python code and returns results.
     - Handles both tabular and chart outputs.

2. **`upload-to-db.py`**  
   - A utility script for uploading CSV data to MongoDB.
   - Reads CSV files and inserts data into the MongoDB collection.

3. **`static/`**  
   - Stores images for charts generated by the API.

4. **`.env`**  
   - Configuration file for environment variables, including database and Azure OpenAI credentials.

---

## Prerequisites

Ensure you have the following installed and configured:

- **Python 3.9+**
- **MongoDB** (Local or Cloud)
- **Azure OpenAI** (API Key and Deployment)

---

## Setup

### 1. Clone the Repository

Clone the repository and navigate to the server directory:

```bash
git clone https://github.com/samlak/ai-data-analyst
cd ai-data-analyst/server
```

### 2. Install Dependencies

Install required Python libraries:

```bash
pip install -r requirements.txt
```

### 3. Configure Environment Variables

Create a `.env` file in the `server/` directory with the following:

```env
AZURE_OPENAI_ENDPOINT=<your-azure-endpoint>
AZURE_OPENAI_DEPLOYMENT=<your-model-deployment-name>
AZURE_API_VERSION=<api-version>
AZURE_API_KEY=<your-api-key>
MONGO_URI=<your-mongodb-uri>
MONGO_DB_NAME=<your-database-name>
MONGO_COLLECTION_NAME=<your-collection-name>
```

Replace placeholders with your configuration details.

### 4. Set Up MongoDB Data

Use the `upload-to-db.py` script to upload your data to MongoDB. For example:

```bash
python upload-to-db.py
```

This script reads a CSV file, formats it as JSON, and uploads it to the specified MongoDB collection.

### 5. Start the Server

Run the FastAPI server:

```bash
uvicorn main:app --host 0.0.0.0 --port 8000
```

Access the API documentation at:

```
http://localhost:8000/docs
```

---

## Key Endpoints

### `/query`

- **Method**: GET  
- **Description**: Process natural language queries to analyze MongoDB data.
- **Query Parameter**:
  - `question` (string): The natural language query.
- **Response**:
  - **`table_output_verified`** (bool): Indicates whether the result includes a valid tabular output.
  - **`execution_result`** (string): The raw output of the executed Python code.
  - **`image_url`** (string, optional): Path to a generated chart (if applicable).
  - **`analysis`** (string, optional): A short analysis summarizing the result.

#### Example Request
```http
GET /query?question=What are the top 5 procurement categories by total spending?
```

#### Example Response
```json
{
  "table_output_verified": true,
  "execution_result": "<html table with tabulated data>",
  "image_url": null,
  "analysis": "The top 5 procurement categories by total spending are: Office Supplies, IT Equipment, Consulting Services, Transportation, and Construction."
}
```

---

## Code Execution Workflow

1. **Natural Language Input**:  
   The user provides a question via the `/query` endpoint.

2. **Schema and Sample Data**:  
   - The API retrieves the schema of the MongoDB collection.
   - A sample of 3 documents is fetched to guide code generation.

3. **Code Generation**:  
   Azure OpenAI generates Python code to answer the question.

4. **Execution**:  
   - The generated code is executed against the MongoDB dataset.
   - Output is captured and verified for tabular or visual results.

5. **Response**:  
   - Tabular data is returned in HTML format.
   - Charts are saved as PNG files and provided as URLs.
